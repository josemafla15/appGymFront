<div class="do-workout">
  <div class="page-header">
    <button mat-icon-button (click)="onCancel()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div>
      <h1>{{ workoutDay?.name || (workoutDay?.type! | workoutType) }}</h1>
      <p>Complete your workout</p>
    </div>
  </div>
<app-loading-spinner *ngIf="loading"></app-loading-spinner>
<app-alert *ngIf="errorMessage" type="error" [message]="errorMessage"></app-alert>
  <form [formGroup]="workoutForm" *ngIf="!loading && workoutDay">
    <!-- Exercises -->
    <div formArrayName="exercises" class="exercises-list">
      <mat-card *ngFor="let exercise of exercisesArray.controls; let i = index" [formGroupName]="i" class="exercise-card">
        <mat-card-header>
          <mat-card-title>
            <span>{{ exercise.get('exercise_name')?.value }}</span>
            <button mat-icon-button type="button" 
                    (click)="onAddExerciseNote(i)"
                    [class.has-note]="hasNote(i)"
                    matTooltip="Add note">
              <mat-icon>{{ hasNote(i) ? 'edit_note' : 'note_add' }}</mat-icon>
            </button>
          </mat-card-title>
        </mat-card-header>
    <mat-card-content>
      <!-- Sets Table -->
      <div formArrayName="sets" class="sets-container">
        <table class="sets-table">
          <thead>
            <tr>
              <th>Set</th>
              <th>Reps</th>
              <th>Weight (kg)</th>
              <th>Done</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let set of getSetsArray(i).controls; let j = index" 
                [formGroupName]="j"
                [class.completed]="set.get('completed')?.value">
              <td class="set-number">{{ j + 1 }}</td>
              
              <td class="input-cell">
                <mat-form-field appearance="outline" class="compact-field">
                  <input matInput type="number" formControlName="reps" min="0"
                         [readonly]="set.get('completed')?.value">
                </mat-form-field>
              </td>

              <td class="input-cell">
                <mat-form-field appearance="outline" class="compact-field">
                  <input matInput type="number" formControlName="weight" min="0" step="2.5"
                         [readonly]="set.get('completed')?.value">
                </mat-form-field>
              </td>

              <td class="checkbox-cell">
                <mat-checkbox 
                  formControlName="completed"
                  [disabled]="set.get('completed')?.value"
                  (change)="onSetCompleted(i, j)">
                </mat-checkbox>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Actions -->
<div class="action-buttons">
  <button mat-stroked-button type="button" (click)="onCancel()">
    Cancel
  </button>
  <button mat-raised-button color="primary" type="button" 
          (click)="onFinishWorkout()"
          [disabled]="!allSetsCompleted() || saving">
    <mat-icon>check_circle</mat-icon>
    <span *ngIf="!saving">Finish Workout</span>
    <mat-spinner *ngIf="saving" diameter="20"></mat-spinner>
  </button>
</div>
  </form>
</div>